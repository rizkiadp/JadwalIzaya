<!DOCTYPE html>

<html lang="id">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Tugas &amp; Deadline - Study Planner</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect x=%2210%22 y=%2220%22 width=%2280%22 height=%2270%22 rx=%2210%22 ry=%2210%22 fill=%22%23f490b1%22/><rect x=%2225%22 y=%2210%22 width=%2215%22 height=%2220%22 rx=%225%22 ry=%225%22 fill=%22%23ffb7ce%22/><rect x=%2260%22 y=%2210%22 width=%2215%22 height=%2220%22 rx=%225%22 ry=%225%22 fill=%22%23ffb7ce%22/><rect x=%2225%22 y=%2240%22 width=%2250%22 height=%225%22 rx=%222%22 ry=%222%22 fill=%22white%22/><rect x=%2225%22 y=%2255%22 width=%2250%22 height=%225%22 rx=%222%22 ry=%222%22 fill=%22white%22/><rect x=%2225%22 y=%2270%22 width=%2230%22 height=%225%22 rx=%222%22 ry=%222%22 fill=%22white%22/></svg>">
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#f490b1",
                        "background-light": "#fff5f8",
                        "background-dark": "#211116",
                        "neutral-soft": "#fdf2f5",
                        "high-priority": "#f490b1",
                        "med-priority": "#ffb7ce",
                        "low-priority": "#ffe0e9",
                    },
                    fontFamily: {
                        "display": ["Plus Jakarta Sans", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.5rem",
                        "lg": "1.25rem", // 20px
                        "xl": "1.5rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        .custom-checkbox:checked {
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        /* Modal Animation */
        .modal-enter {
            opacity: 0;
            transform: scale(0.9);
        }

        .modal-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: opacity 0.3s ease, transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .modal-exit {
            opacity: 1;
            transform: scale(1);
        }

        .modal-exit-active {
            opacity: 0;
            transform: scale(0.9);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }
    </style>
    <style>
        body {
            min-height: max(884px, 100dvh);
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark min-h-screen text-[#4a343a]">
    <!-- Main Container -->
    <div class="relative flex flex-col max-w-md mx-auto min-h-screen bg-background-light dark:bg-background-dark pb-24">
        <!-- Header -->
        <header class="flex items-center justify-between p-6 pt-8">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 flex items-center justify-center rounded-lg bg-primary/10 text-primary">
                    <span class="material-symbols-outlined">menu_book</span>
                </div>
                <h1 class="text-2xl font-bold tracking-tight text-[#2d1b22]">Tugas &amp; Deadline</h1>
            </div>
            <button
                class="w-10 h-10 flex items-center justify-center rounded-full bg-white shadow-sm border border-primary/10">
                <span class="material-symbols-outlined text-primary">search</span>
            </button>
        </header>
        <!-- Filters -->
        <div class="flex gap-3 px-6 mb-6 overflow-x-auto no-scrollbar">
            <button
                class="px-5 py-2.5 rounded-full bg-primary text-white text-sm font-semibold shadow-md shadow-primary/20 whitespace-nowrap">
                Semua
            </button>
            <button
                class="px-5 py-2.5 rounded-full bg-white text-[#994d66] text-sm font-semibold border border-primary/10 whitespace-nowrap">
                Belum Selesai
            </button>
            <button
                class="px-5 py-2.5 rounded-full bg-white text-[#994d66] text-sm font-semibold border border-primary/10 whitespace-nowrap">
                Selesai
            </button>
        </div>
        <!-- Task List -->
        <div id="taskList" class="flex flex-col gap-4 px-6">
            <div class="text-center text-zinc-400 py-10">Memuat tugas...</div>
        </div>

        <!-- Floating Action Button -->
        <button onclick="window.location.href='../../pages/add-task/index.html'"
            class="fixed bottom-24 right-6 w-16 h-16 rounded-full bg-primary text-white shadow-lg shadow-primary/40 flex items-center justify-center transition-transform hover:scale-110 active:scale-95 z-50">
            <span class="material-symbols-outlined text-3xl">add</span>
        </button>
        <!-- Bottom Navigation -->
        <nav
            class="fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-md bg-white/90 dark:bg-zinc-900/90 backdrop-blur-md border-t border-primary/10 px-6 py-3 flex items-center justify-around z-40 rounded-t-2xl">
            <a class="flex flex-col items-center gap-1 group relative" href="../../pages/home/index.html">
                <span
                    class="material-symbols-outlined text-text-main/40 dark:text-zinc-500 group-hover:text-primary transition-colors">home</span>
                <span
                    class="text-[10px] font-bold text-text-main/40 dark:text-zinc-500 uppercase tracking-tighter group-hover:text-primary transition-colors">Beranda</span>
            </a>
            <a class="flex flex-col items-center gap-1 group relative" href="../../pages/day-detail-v2/index.html">
                <span
                    class="material-symbols-outlined text-text-main/40 dark:text-zinc-500 group-hover:text-primary transition-colors">calendar_today</span>
                <span
                    class="text-[10px] font-bold text-text-main/40 dark:text-zinc-500 uppercase tracking-tighter group-hover:text-primary transition-colors">Jadwal</span>
            </a>
            <a class="flex flex-col items-center gap-1 group relative" href="#">
                <div class="w-10 h-1 rounded-full bg-primary absolute -top-3 block"></div>
                <span class="material-symbols-outlined text-primary"
                    style="font-variation-settings: 'FILL' 1">checklist</span>
                <span class="text-[10px] font-bold text-primary uppercase tracking-tighter">Tugas</span>
            </a>
            <a class="flex flex-col items-center gap-1 group" href="../../pages/profile/index.html">
                <span
                    class="material-symbols-outlined text-text-main/40 dark:text-zinc-500 group-hover:text-primary transition-colors">person</span>
                <span
                    class="text-[10px] font-bold text-text-main/40 dark:text-zinc-500 uppercase tracking-tighter group-hover:text-primary transition-colors">Profil</span>
            </a>
        </nav>

        <!-- Cute Delete Modal -->
        <div id="deleteModal"
            class="hidden absolute inset-0 z-50 flex items-center justify-center p-4 bg-black/20 backdrop-blur-sm">
            <div class="bg-white dark:bg-zinc-800 w-full max-w-sm rounded-3xl p-6 shadow-soft-pink border-2 border-primary/20 flex flex-col items-center text-center transform transition-all"
                id="deleteModalContent">
                <div class="w-20 h-20 rounded-full bg-red-50 flex items-center justify-center mb-4 animate-bounce">
                    <span class="material-symbols-outlined text-4xl text-red-400">delete_forever</span>
                </div>
                <h3 class="text-xl font-bold text-text-main dark:text-zinc-100 mb-2">Hapus Tugas?</h3>
                <p class="text-text-main/60 dark:text-zinc-400 text-sm mb-6">Yakin mau hapus tugas ini? Nanti gabisa
                    dibalikin lho...</p>

                <div class="flex gap-3 w-full">
                    <button onclick="closeDeleteModal()"
                        class="flex-1 py-3 rounded-xl font-bold text-text-main/60 bg-gray-100 hover:bg-gray-200 transition-colors">
                        Gajadi
                    </button>
                    <button id="confirmDeleteBtn"
                        class="flex-1 py-3 rounded-xl font-bold text-white bg-primary hover:bg-primary-light shadow-lg shadow-primary/30 transition-all active:scale-95">
                        Iya, Hapus!
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div
        class="fixed top-20 -left-10 w-40 h-40 bg-pink-100 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob">
    </div>
    <div
        class="fixed top-20 -right-10 w-40 h-40 bg-purple-100 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-2000">
    </div>
    <div
        class="fixed -bottom-8 left-20 w-40 h-40 bg-yellow-100 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-4000">
    </div>

    <script src="../../config.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('token');
            const userStr = localStorage.getItem('user');

            if (!token || !userStr) {
                window.location.href = '../../pages/login/index.html';
                return;
            }

            const user = JSON.parse(userStr);

            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/api/tasks?user_id=${user.id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to fetch');

                const tasks = await response.json();
                renderTasks(tasks);

            } catch (error) {
                console.error(error);
                document.getElementById('taskList').innerHTML = '<div class="text-center text-red-400 py-10">Gagal memuat tugas.</div>';
            }
        });

        function renderTasks(tasks) {
            const container = document.getElementById('taskList');
            container.innerHTML = '';

            if (tasks.length === 0) {
                container.innerHTML = '<div class="text-center text-zinc-400 py-10">Belum ada tugas.</div>';
                return;
            }

            tasks.forEach(task => {
                const isCompleted = task.completed;
                const item = document.createElement('div');

                // Priority colors
                let priorityColor = 'bg-primary/20';
                let priorityText = 'text-primary';
                let borderClass = 'border-primary/5';

                if (task.priority === 'High') {
                    priorityColor = 'bg-high-priority';
                    priorityText = 'text-high-priority';
                } else if (task.priority === 'Medium') {
                    priorityColor = 'bg-med-priority';
                    priorityText = 'text-med-priority';
                } else {
                    priorityColor = 'bg-low-priority';
                }

                // Completed styling
                const opacityClass = isCompleted ? 'opacity-60 bg-white/60' : 'bg-white';
                const textLine = isCompleted ? 'line-through' : '';
                const checkedAttr = isCompleted ? 'checked' : '';

                item.className = `${opacityClass} rounded-lg p-4 shadow-sm border ${borderClass} flex items-center gap-4 relative overflow-hidden transition-all`;

                item.innerHTML = `
                <div class="absolute left-0 top-0 bottom-0 w-1.5 ${priorityColor}"></div>
                <div class="flex-shrink-0">
                    <input ${checkedAttr} onchange="toggleTask('${task.id}', this.checked)" class="custom-checkbox w-6 h-6 rounded-full border-2 border-primary text-primary focus:ring-primary/20 bg-transparent transition-all cursor-pointer" type="checkbox"/>
                </div>
                <div class="flex-grow">
                    <h3 class="font-bold text-[#2d1b22] leading-tight ${textLine}">${task.title}</h3>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="text-xs font-medium text-primary/80">${task.course || 'General'}</span>
                        <span class="w-1 h-1 rounded-full bg-primary/30"></span>
                        <div class="flex items-center gap-1 text-[#994d66]">
                            <span class="material-symbols-outlined text-[14px]">calendar_today</span>
                            <span class="text-xs">${task.date || '-'}</span>
                        </div>
                    </div>
                </div>
                <div class="flex flex-col items-end gap-2">
                    <span class="px-2 py-0.5 rounded-full ${isCompleted ? 'bg-primary/5 text-primary/40' : priorityColor + '/10 ' + priorityText} text-[10px] font-bold uppercase tracking-wider">
                        ${isCompleted ? 'Selesai' : (task.priority || 'Normal')}
                    </span>
                    <button onclick="deleteTask('${task.id}')" class="text-zinc-300 hover:text-red-400 transition-colors">
                        <span class="material-symbols-outlined text-sm">delete</span>
                    </button>
                </div>
            `;
                container.appendChild(item);
            });
        }

        async function toggleTask(id, completed) {
            try {
                await fetch(`${CONFIG.API_BASE_URL}/api/tasks/${id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ completed })
                });
                // Reload to update UI state cleanly
                location.reload();
            } catch (e) {
                alert('Gagal update task');
            }
        }

        // --- Delete Modal Logic ---
        let deleteIdTarget = null;

        function showDeleteModal(id) {
            deleteIdTarget = id;
            const modal = document.getElementById('deleteModal');
            const content = document.getElementById('deleteModalContent');

            modal.classList.remove('hidden');
            content.classList.remove('modal-exit', 'modal-exit-active');
            content.classList.add('modal-enter');
            void content.offsetWidth;
            content.classList.add('modal-enter-active');
            content.classList.remove('modal-enter');
        }

        function closeDeleteModal() {
            const modal = document.getElementById('deleteModal');
            const content = document.getElementById('deleteModalContent');

            content.classList.remove('modal-enter-active');
            content.classList.add('modal-exit');
            void content.offsetWidth;
            content.classList.add('modal-exit-active');

            setTimeout(() => {
                modal.classList.add('hidden');
                deleteIdTarget = null;
            }, 200);
        }

        document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
            if (!deleteIdTarget) return;
            const id = deleteIdTarget;
            const btn = document.getElementById('confirmDeleteBtn');
            const originalText = btn.textContent;

            btn.textContent = 'Menghapus...';
            btn.disabled = true;

            try {
                await fetch(`${CONFIG.API_BASE_URL}/api/tasks/${id}`, { method: 'DELETE' });
                location.reload();
            } catch (e) {
                alert('Gagal hapus task');
                closeDeleteModal();
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        });

        function deleteTask(id) {
            showDeleteModal(id);
        }
    </script>
</body>

</html>